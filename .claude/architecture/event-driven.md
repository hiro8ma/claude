# イベント駆動アーキテクチャ

## ドメインイベント

### 基本フロー

1. 集約のコマンドが呼び出される
2. ローカルトランザクションがコミット → ドメインイベント生成 → Publisher発行
3. Subscriberがイベントを購読し処理
   - イベントストアへの永続化
   - 参照用モデルの更新
   - 次のイベントの発行

## イベントソーシング

ドメインイベントが複数サービスにまたがる場合に使用。

### 特徴

- サービス同士を疎結合に保つ
- 状態ではなく変更イベントを非同期にやりとり
- 大規模データの取り扱いが容易
- データ結合の直列処理 → 結果整合性ベースのロジックへ

## Sagaパターン

複数サービスを介する場合にローカルACIDトランザクションを非同期に繋いでワークフローを構築。

### 障害対応

#### 後方回復（推奨）

障害地点までのイベントを逆向きに発行。

**補償トランザクション**: 各集約単位のローカルトランザクションを逆向きイベント発行と共にロールバック。

#### 前方回復

障害地点から正向きにイベントを発行（非推奨）。

## CQRS

更新系（コマンド）と参照系（クエリ）を分離。

### タイムラグ対策

コマンド処理中はローカルトランザクションより参照用モデルが後退する可能性がある。

**対策**: 処理中の各集約に楽観的ロックをかけ、更新処理中であることをユーザーに開示。
